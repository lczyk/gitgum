#!/usr/bin/env bash
# spellchecker: words gitgum worktree worktrees Marcin Konowalczyk lczyk
# A bunch of git commands with 'gum'
# Written by Marcin Konowalczyk @lczyk

# Get the directory where this script is located
# This does not work since we may be called via symlink
# SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_DIR="$(cd "$(dirname "$(realpath "$0")")" && pwd)"

# echo "Loading gitgum from $SCRIPT_DIR"
# exit 99
# Source helper modules
source "$SCRIPT_DIR/helpers.sh"
source "$SCRIPT_DIR/backends/backend_gum.sh"

# Source command modules
source "$SCRIPT_DIR/commands/tree.sh"
source "$SCRIPT_DIR/commands/push.sh"
source "$SCRIPT_DIR/commands/delete.sh"
source "$SCRIPT_DIR/commands/status.sh"
source "$SCRIPT_DIR/commands/commit.sh"
source "$SCRIPT_DIR/commands/switch.sh"
source "$SCRIPT_DIR/commands/merge_into.sh"
source "$SCRIPT_DIR/commands/completion.sh"

# Main help text
HELP="""
Usage: gitgum <command> [args]
Commands:
    tree          Show the git tree structure
    push          Push the current branch to a remote repository interactively
    delete        Delete a branch or a remote branch interactively
    status        Show the status of the current git repository
    commit        Commit changes in the current branch interactively
    switch        Switch to a branch interactively
    merge-into    Merge current branch into another branch
    completion    Output shell completion script
    help          Show this help message
For more information, run 'gitgum <command> --help'.
"""

function gitgum() {
    local command="$1"
    shift

    # Handle help or no command
    if [[ -z "$command" ]] || [[ "$command" == "help" ]] || [[ "$command" == "--help" ]] || [[ "$command" == "-h" ]]; then
        echo "$HELP"
        return 0
    fi

    # Check if gum is installed
    if ! command -v gum &>/dev/null; then
        echo "gum is not installed. Please install it first."
        return 1
    fi

    # Check if git is installed
    if ! command -v git &>/dev/null; then
        echo "git is not installed. Please install it first."
        return 1
    fi



    # Dispatch to command handlers
    case "$command" in
        tree)
            gitgum::cmd::tree "$@"
            ;;
        push)
            gitgum::cmd::push "$@"
            ;;
        delete)
            gitgum::cmd::delete "$@"
            ;;
        status)
            gitgum::cmd::status "$@"
            ;;
        commit)
            gitgum::cmd::commit "$@"
            ;;
        switch)
            gitgum::cmd::switch "$@"
            ;;
        merge-into)
            gitgum::cmd::merge_into "$@"
            ;;
        completion)
            gitgum::cmd::completion "$@"
            ;;
        *)
            echo "Unknown command: $command"
            return 1
            ;;
    esac
}

# Main entry point
gitgum "$@"

## TODO:
# - git branch and checkout in one
# - git status + git branch -vva + git remote -v in one
# - tests with bash_unit
